#!/bin/bash

# lbnecheckout
# Check out the development packages.

PKGFILE=./packages.txt
if ! test -r $PKGFILE; then
  Package file not found: $PKGFILE
  exit 1
fi

# Perform setup if needed.
if test -z $LBNE_IS_SETUP; then
  source ./lbnesetup.sh
  if test -z $LBNE_IS_SETUP; then
    echo LBNE setup failed.
    exit 1
  fi
fi

# Create working area if needed.
HAVE_WORKDIR=`ls -d workdir 2>/dev/null`
echo $LINE
if [ -z "$HAVE_WORKDIR" ]; then
  echo Creating new workdir
  mkdir workdir
else
  echo Using existing workdir
fi

cd workdir
echo $LINE
echo Setting up for local products
# Not-needed? source /grid/fermiapp/products/larsoft/setup
setup git
setup gitflow
setup mrb
export MRB_PROJECT=larsoft

echo $LINE
echo Setting up larsoft
setup larsoft $LBNE_LARVERSION -q $LBNE_RQUAL

if [ -z "$HAVE_WORKDIR" ]; then
  echo $LINE
  echo Creating mrb area
  mrb newDev 
  echo MRB_BUILDIR = $MRB_BUILDDIR
fi

source localProducts_$LBNE_LARPROD/setup

cd srcs
# Loop over local packages and check out if not already present.
echo $LINE
echo Checking out packages
LOCALPRODS=`cat $PKGFILE`
for PKG in $LOCALPRODS; do
  echo $LINE
  if test -r $PKG; then
    echo Package $PKG is already checked out
  else
    echo Checking out $PKG
    if [ $PKG = LArViewer ]; then
      git clone https://github.com/czczc/LArViewer.git
      cp -r LArViewer/LBNE35t/DataConverter lbnecode/lbne
    else
      mrb gitCheckout $PKG
      echo $LINE
      echo Create local feature branch
      cd $PKG
      git flow feature start $GIT_BRANCH_NAME
      cd ..
    fi
  fi
done

echo $LINE
echo Building
cd $MRB_BUILDDIR
mrbsetenv
mrb i -j4

echo Set up to run
mrbslp
cd $THISDIR

echo
echo Generate an event: lar -n 10 -c prodsingle_lbne35t.fcl
echo Event display: lar -c evd_lbne35t.fcl single35t_gen.root
